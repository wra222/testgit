using System;
using System.Linq;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using IMES.CheckItemModule.Interface;
using IMES.CheckItemModule.Utility;
using IMES.DataModel;
using IMES.FisObject.Common.FisBOM;
using IMES.FisObject.Common.Part;
using IMES.Infrastructure;
using System.Text.RegularExpressions;
using IMES.Infrastructure.Util;
using IMES.Resolve.Common;
using IMES.FisObject.PCA.MB;
using IMES.Infrastructure.FisObjectRepositoryFramework;

namespace IMES.CheckItemModule.CQ.SmallBoard.Filter
{
    [Export(typeof(IMatchModule))]
    [ExportMetadata("ProgramName", "IMES.CheckItemModule.CQ.SmallBoard.Filter.dll")]
    public class MatchModule : IMatchModule
    {
        static readonly IMBRepository mbRep = RepositoryFactory.GetInstance().GetRepository<IMBRepository, IMB>();
        private const string IsSmallBoard = "IsSmallBoard";
        public object Match(string subject, object bomItem, string station)
        {
            if (subject == null)
            {
                throw new ArgumentNullException();
            }
            if (bomItem == null)
            {
                throw new ArgumentNullException();
            }
            PartUnit ret = null;
            FlatBOMItem  flatBomitem=(FlatBOMItem)bomItem;

            IList<CheckItemTypeRuleDef> lstChkItemRule =flatBomitem.CheckItemTypeRuleList;
            if (null == lstChkItemRule || lstChkItemRule.Count == 0)
            {
                throw new FisException("No ChkItemTypeRule!!");
            }            

            IList<IPart> partList = flatBomitem.AlterParts;
            IPart matchPart = null;
            CheckItemTypeRuleDef chkItemRule = lstChkItemRule[0];

            IList<string> mbCodeList = (IList<string>)flatBomitem.Tag;

            if (Regex.IsMatch(subject, chkItemRule.MatchRule))
            { 
                string mbCode = null;
                if (subject.Length > 10)
                {
                    mbCode = subject.Substring(0, 3);
                }
                else
                {
                    mbCode = subject.Substring(0, 2);
                }

                if (mbCodeList.Contains(mbCode))
                {
                    IMB mb=mbRep.Find(subject);
                    if (mb == null  || 
                        !mb.MBInfos.Any(x=>x.InfoType == IsSmallBoard && x.InfoValue== GlobalConstName.Letter.Y))
                    {
                        throw new FisException("ICT029", new string[] { subject });
                    }

                   matchPart= partList.Where(x=>x.Attributes.Any(y=>y.InfoType == GlobalConstName.PartInfo.MBCode && 
                                                                                                     y.InfoValue == mbCode)).FirstOrDefault();
                   

                    if (matchPart == null && !string.IsNullOrEmpty(mb.PCBModelID))
                    {
                        matchPart = partList.Where(x => x.PartNo == mb.PCBModelID).FirstOrDefault();                        
                    }

                    if (matchPart == null)
                    {                      
                       matchPart = partList[0];
                    }

                    ret = new PartUnit(matchPart.PN,
                                                 subject,
                                                 matchPart.BOMNodeType,
                                                 matchPart.Type,
                                                 matchPart.PN,
                                                 string.Empty,
                                                 flatBomitem.CheckItemType);
                }
                else
                {
                    throw new FisException("ICT028", new string[] { mbCode, string.Join(GlobalConstName.CommaStr, mbCodeList.ToArray()) });
                }               

            }

            return ret;           
        } 
    }
}
