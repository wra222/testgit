using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using com.inventec.iMESWEB;
using IMES.DataModel;
using System.Collections.Generic;
using IMES.Infrastructure;
using System.Text;
using IMES.Station.Interface.StationIntf;
using System.IO;
public partial class SA_MaterialSend : System.Web.UI.Page
{
    private const int DEFAULT_ROWS = 15;
    public string Pre = WebCommonMethod.getConfiguration(WebConstant.LANGUAGE);
    public String UserId;
    public String Customer;
    IMaterialRequest imaterialrequest = ServiceAgent.getInstance().GetObjectByName<IMaterialRequest>(WebConstant.SAMBRepairControl);

    protected void Page_Load(object sender, EventArgs e)
    {
       // this.cmdstage.AutoPostBack = true;
        //this.cmdstage.SelectedIndexChanged += new EventHandler(cmdstage_Selected);
        UserId = Master.userInfo.UserId;
        Customer = Master.userInfo.Customer;
        if (!this.IsPostBack)
        {
            string[] stagelist = (Request["StageList"] ?? "SA,FA,PAK").Split(',', '~');
            string query = Request["Query"] ?? "N";
            try
            {
                this.cmdstage.Items.Add("");
                foreach (string stage in stagelist)
                {

                    this.cmdstage.Items.Add(stage);

                }
                if (query == "Y")
                {
                    this.btdel.Disabled = true;
                    this.btnAdd.Disabled = true;
                }
                BindAllGridview(null, 10);

            }

            catch (Exception ee)
            {
                showErrorMessage(ee.Message);
                return;
            }


        }

    }
    protected void gd_RowDataBound(object sender, GridViewRowEventArgs e)
    {


        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            for (int i = 0; i < e.Row.Cells.Count; i++)
            {
                if (!String.IsNullOrEmpty(e.Row.Cells[i].Text.Trim()) && !(e.Row.Cells[i].Text.Trim().ToLower() == "&nbsp;"))
                {
                    e.Row.Cells[i].ToolTip = e.Row.Cells[i].Text;
                }
            }

        }
    }
    private string replaceSpecialChart(string errorMsg)
    {
        errorMsg = errorMsg.Replace("'", "\\'");
        return errorMsg;
    }
    protected void cmdstage_Selected(object sender, EventArgs e)
    {
        string stage = this.cmdstage.SelectedValue.Trim();
        this.cmbPdLine.Customer = Customer;
        this.cmbPdLine.Stage = stage;
        this.cmbPdLine.refresh();
        this.UpdatePanel6.Update();
    }
    protected void btupdate_ServerClick(object sender, EventArgs e)
    {
        try
        {

            string id = this.hidDeleteID.Value.ToString();
            if (string.IsNullOrEmpty(id))
            {
                throw new FisException("This ID is not Exists");
            }
            string remark=txtremark.Text.Trim();
            int delID = int.Parse(id);
          IList<MBRepairControlInfo> queryret= imaterialrequest.GeMaterialRequest(new MBRepairControlInfo { ID = delID });
          if (queryret.Where(x => x.Status != "Waiting").Any())
          {
              showErrorMessage("此 ID" + delID + "状态非Waiting 不允许发料，请重新Query!");
              return;
          }
          else
          {
              imaterialrequest.UpdateMBRepairControl(new MBRepairControlInfo { ID = delID, Status = "Approve", Remark = remark });
            IList<MBRepairControlInfo> ret = imaterialrequest.GeMaterialRequest(new MBRepairControlInfo { ID = delID });
            BindAllGridview(ret,10);
            ScriptManager.RegisterStartupScript(this.UpdatePanel1, typeof(System.Object), "Delete", "unpdateComplete();", true);
          }
        }
        catch (FisException fex)
        {

            showErrorMessage(fex.mErrmsg);
            return;
        }
        catch (System.Exception ex)
        {
            showErrorMessage(ex.Message);
        }
        finally
        {

        }
    }
    protected void btquery_ServerClick(object sender, EventArgs e)
    {
        string stage = cmdstage.SelectedValue.Trim();
        string pdline = cmbPdLine.InnerDropDownList.SelectedValue.Trim();
        string partno=txtpartno.Text.Trim();
        string family=txtfamily.Text.Trim();
        string staus=cmdstatus.SelectedValue.Trim();
        DateTime begin=Convert.ToDateTime( selectfromdate.Value);
         DateTime end=Convert.ToDateTime( selecttodate.Value);
          MBRepairControlInfo condition=new MBRepairControlInfo();
         condition.Stage=stage;
        condition.MaterialType= "Component";
        if (!string.IsNullOrEmpty(pdline))
        {
          condition.Line=pdline;
        }
          if (!string.IsNullOrEmpty(partno))
        {
          condition.PartNo=partno;
        }
         if (!string.IsNullOrEmpty(family))
        {
          condition.Family=family;
        }
         if (!string.IsNullOrEmpty(staus))
        {
          condition.Status=staus;
        }
           MBRepairControlInfo betweencondition=new MBRepairControlInfo{Cdt=DateTime.Now};
           IList<MBRepairControlInfo> ControlInfo = imaterialrequest.GeMaterialRequest(condition, betweencondition, "Cdt", begin, end);

           BindAllGridview(ControlInfo,10);
            
    }
    protected void BindAllGridview(IList<MBRepairControlInfo> list, int defaultRow)
    {
        if (list != null)
        {
            bindTable2(list.Where(x => x.Status == "Waiting").ToList(), defaultRow);
            BindGD2(list.Where(x => x.Status == "Approve").ToList(), defaultRow);
        }
        else
        {
            bindTable2(null, defaultRow);
            BindGD2(null, defaultRow);
        }

    }
    protected void btnToExcel_ServerClick(object sender, System.EventArgs e)
    {
        DataTable dt = GetNullTable();
        if (gd.Rows.Count>0)
        {
            for (int j = 0; j < gd.Rows.Count; j++)
            {
                DataRow dr = dt.NewRow();
                for (int i = 0; i < gd.HeaderRow.Cells.Count; i++)
                {
                    dr[i] = gd.Rows[j].Cells[i].Text.Trim();
                }

                dt.Rows.Add(dr);
            }
           
        }
        if (gd2.Rows.Count > 0)
        {
            for (int j = 0; j < gd2.Rows.Count; j++)
            {
                DataRow dr = dt.NewRow();
                for (int i = 0; i < gd2.HeaderRow.Cells.Count; i++)
                {
                    dr[i] = gd2.Rows[j].Cells[i].Text.Trim();
                }

                dt.Rows.Add(dr);
            }
        
        }
        if (dt.Rows.Count > 0)
        {
            DataTable2Excel(dt);
        }
        else
        {
            showErrorMessage("无数据可导出！");
        }
    }
    protected void bindgd()
    {
        IList<MBRepairControlInfo> ControlInfo = imaterialrequest.GeMaterialRequest(new MBRepairControlInfo());
        bindTable2(ControlInfo, 1);
    }
    private void bindTable2(IList<MBRepairControlInfo> list, int defaultRow)
    {

        DataTable dt = GetNullTable();
        DataRow dr = null;
        if (list != null && list.Count != 0)
        {
            foreach (MBRepairControlInfo temp in list)
            {
                dr = dt.NewRow();
                dr[0] = temp.ID;
                dr[1] = temp.PartNo;
                dr[2] = temp.Stage;
                dr[3] = temp.Family;
                dr[4] = temp.PCBModelID;
                dr[5] = temp.Line;
                dr[6] = temp.Location;
                dr[7] = temp.Qty;
                dr[8] = temp.Status;
                dr[9] = temp.Loc;
                dr[10] = temp.AssignUser;
                dr[11] = temp.Remark;
                dr[12] = temp.Editor;
                dr[13] = temp.Cdt;
                dr[14] = temp.Udt;
                dt.Rows.Add(dr);
            }

            for (int i = list.Count; i < DEFAULT_ROWS; i++)
            {
                dt.Rows.Add(dt.NewRow());
            }


        }
        else
        {
            for (int i = 0; i < defaultRow; i++)
            {
                dr = dt.NewRow();
                dt.Rows.Add(dr);
            }


        }

        gd.DataSource = dt;
        gd.DataBind();
        this.UpdatePanel1.Update();
        setColumnWidth();
        ScriptManager.RegisterStartupScript(this.UpdatePanel1, typeof(System.Object), "newIndex", "iSelectedRowIndex = null;", true);
    }
    private void BindGD2(IList<MBRepairControlInfo> list, int defaultRow)
    {
        DataTable dt = GetNullTable();
        DataRow dr = null;
        if (list != null && list.Count != 0)
        {
            foreach (MBRepairControlInfo temp in list)
            {
                dr = dt.NewRow();
                dr[0] = temp.ID;
                dr[1] = temp.PartNo;
                dr[2] = temp.Stage;
                dr[3] = temp.Family;
                dr[4] = temp.PCBModelID;
                dr[5] = temp.Line;
                dr[6] = temp.Location;
                dr[7] = temp.Qty;
                dr[8] = temp.Status;
                dr[9] = temp.Loc;
                dr[10] = temp.AssignUser;
                dr[11] = temp.Remark;
                dr[12] = temp.Editor;
                dr[13] = temp.Cdt;
                dr[14] = temp.Udt;
                dt.Rows.Add(dr);
            }

            for (int i = list.Count; i < DEFAULT_ROWS; i++)
            {
                dt.Rows.Add(dt.NewRow());
            }


        }
        else
        {
            for (int i = 0; i < defaultRow; i++)
            {
                dr = dt.NewRow();
                dt.Rows.Add(dr);
            }


        }
        gd2.DataSource = dt;
        gd2.DataBind();
        this.UpdatePanel2.Update();
        setgd2ColumnWidth();
       
    }
    private void setColumnWidth()
    {
        gd.HeaderRow.Cells[0].Width = Unit.Parse("30");
        gd.HeaderRow.Cells[1].Width = Unit.Parse("90");
        gd.HeaderRow.Cells[2].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[3].Width = Unit.Parse("90");
        gd.HeaderRow.Cells[4].Width = Unit.Parse("90");
        gd.HeaderRow.Cells[5].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[6].Width = Unit.Parse("90");
        gd.HeaderRow.Cells[7].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[8].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[9].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[10].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[11].Width = Unit.Parse("100");
        gd.HeaderRow.Cells[12].Width = Unit.Parse("50");
        gd.HeaderRow.Cells[13].Width = Unit.Parse("130");
        gd.HeaderRow.Cells[14].Width = Unit.Parse("130");
    }
    private void setgd2ColumnWidth()
    {
        gd2.HeaderRow.Cells[0].Width = Unit.Parse("30");
        gd2.HeaderRow.Cells[1].Width = Unit.Parse("90");
        gd2.HeaderRow.Cells[2].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[3].Width = Unit.Parse("90");
        gd2.HeaderRow.Cells[4].Width = Unit.Parse("90");
        gd2.HeaderRow.Cells[5].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[6].Width = Unit.Parse("90");
        gd2.HeaderRow.Cells[7].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[8].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[9].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[10].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[11].Width = Unit.Parse("100");
        gd2.HeaderRow.Cells[12].Width = Unit.Parse("50");
        gd2.HeaderRow.Cells[13].Width = Unit.Parse("130");
        gd2.HeaderRow.Cells[14].Width = Unit.Parse("130");
    }
    private void showErrorMessage(string errorMsg)
    {
        StringBuilder scriptBuilder = new StringBuilder();
        errorMsg = replaceSpecialChart(errorMsg);
        scriptBuilder.AppendLine("<script language='javascript'>");
        scriptBuilder.AppendLine("SetGrDivHeight();ShowMessage('" + errorMsg.Replace("\r\n", "<br>") + "');");
        scriptBuilder.AppendLine("</script>");
        ScriptManager.RegisterStartupScript(this.UpdatePanel1, typeof(System.Object), "showErrorMessage", scriptBuilder.ToString(), false);
    }
    private void showSuccessMessage(string msg)
    {
        StringBuilder scriptBuilder = new StringBuilder();
        msg = replaceSpecialChart(msg);
        scriptBuilder.AppendLine("<script language='javascript'>");
        scriptBuilder.AppendLine("onSaveSucess('" + msg.Replace("\r\n", "<br>") + "');");
        scriptBuilder.AppendLine("</script>");
        ScriptManager.RegisterStartupScript(this.UpdatePanel1, typeof(System.Object), "showErrorMessage", scriptBuilder.ToString(), false);
    }
    private  void DataTable2Excel(System.Data.DataTable dtData)
    {
        System.Web.HttpContext curContext = System.Web.HttpContext.Current;
        MemoryStream ms = ExcelManager.ExportDataTableToExcel(dtData);
        curContext.Response.AddHeader("Content-Disposition", string.Format("attachment; filename=MaterialControlReport.xls"));
        curContext.Response.BinaryWrite(ms.ToArray());
        ms.Close();
        ms.Dispose();
    }
    public DataTable GetNullTable()
    {
        DataTable dt = new DataTable();

          dt.Columns.Add("ID");
           dt.Columns.Add("PartNo");
            dt.Columns.Add("Stage");
            dt.Columns.Add("Family");
            dt.Columns.Add("PCBModelID");
            dt.Columns.Add("Line");
            dt.Columns.Add("Location");
            dt.Columns.Add("Qty");
            dt.Columns.Add("Status");
            dt.Columns.Add("Loc");
            dt.Columns.Add("AssignUser");
            dt.Columns.Add("Remark");
            dt.Columns.Add("Editor");
            dt.Columns.Add("Cdt");
            dt.Columns.Add("Udt");
        return dt;

    }
}
