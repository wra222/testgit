<%--
 INVENTEC corporation (c)2009 all rights reserved. 
 Description: Common input control
 Update: 
 Date        Name                 Reason 
 ==========  ==================   ==============================
 2009-10-27  Tong.Zhi-Yong(EB2)   Create 

 Known issues:
 --%>
<%@ Control Language="C#" AutoEventWireup="true" CodeFile="CommonInputControl.ascx.cs" Inherits="CommonControl_CommonInputControl" %>
<asp:TextBox id="txtInput" runat="server"  Height="25px" BackColor="#ffffa0" BorderColor="Brown" Font-Bold="true" Font-Size="X-Large" ForeColor="Red"  />
<input type="hidden" id="hidKeyAllowTime" runat="server" />
<script language="javascript" type="text/javascript">
    var flag = "";
    var timeStart;
    var timeStop;
    var allowKeyInTime = -1;
    //记录input框输入的数组
    var sInput = new Array(100);
    var sInputOrig = new Array(100);
    //起始的读位置
    var readIndex=0;
    //起始的写位置
    var writeIndex=-1;
    var finishInputFlag = false;
    
    function inputClick() {
        alert("inputClick");
    }
    
    function onDateKeyDown() {
        var inputContent = document.getElementById("<%=txtInput.ClientID%>").value;
     
        if(inputContent.length == 0)
        {
            timeStart = new Date();  
        }
        
        if (event.keyCode == 9 || event.keyCode == 13) 
        {        
            var canUserKeyboard = document.getElementById("<%=txtInput.ClientID%>").getAttribute("keyboard");
            var isClear = document.getElementById("<%=txtInput.ClientID%>").getAttribute("isClear");
            //added by itc207013
            var ETFun= document.getElementById("<%=txtInput.ClientID%>").getAttribute("enterOrTabFun");
            var isKeepWhiteSpace = document.getElementById("<%=txtInput.ClientID%>").getAttribute("keepWhitespace");
        
            if (isClear == null) {
                finishInputFlag = true; 
            }
            
            //document.getElementById("<%=txtInput.ClientID%>").value = "";
            
            if (inputContent.length != 0 && inputContent.trim() != "") {
                if (canUserKeyboard != null) {
                    if (canUserKeyboard.toLowerCase() == "false") {
                        var isScanner = null;
                    
                        timeStop = new Date();
                        isScanner = CountTime(timeStart,timeStop); 
                        if (!isScanner) {
                            //need modify the parameter content
                            alert("Please use scanner to input data!");
                            event.returnValue = false;
                            
                            try
                            {
                                //ShowInfo("Please use scanner to input data!");
                            }
                            catch(e) {
                                  
                                document.getElementById("<%=txtInput.ClientID%>").value = "";
                                document.getElementById("<%=txtInput.ClientID%>").focus();
                                
                                return;
                            }
                            
                            document.getElementById("<%=txtInput.ClientID%>").value = "";
                            document.getElementById("<%=txtInput.ClientID%>").focus();
                            
                            return;       
                        }
                    }
                }

                inputContentOrig = inputContent;
                inputContent = inputContent.toUpperCase();
              
                 document.getElementById("<%=txtInput.ClientID%>").value = inputContent.trim();
              
                if (document.getElementById("<%=txtInput.ClientID%>").getAttribute("ProcessQuickInput") == "true") {
                    writeIndex++;

                    //sInputOrig[writeIndex] = event.returnValue ? content : inputContentOrig.trim();
                    //sInput[writeIndex] = event.returnValue ? content : inputContent.trim();
					
				//	sInputOrig[writeIndex] = inputContentOrig.trim();
				//	sInput[writeIndex] = inputContent.trim();
                    if (isKeepWhiteSpace != null && isKeepWhiteSpace == 'true') {
                        sInputOrig[writeIndex] = inputContentOrig;
                        sInput[writeIndex] = inputContent;
                     }
                    else {
                         sInputOrig[writeIndex] = inputContentOrig.trim();
                         sInput[writeIndex] = inputContent.trim();
                    }
					
				
                }
                
                if (isClear != null) {
                    document.getElementById("<%=txtInput.ClientID%>").value = "";
                }  
                
                event.returnValue = false;
            } else {
                //need modify the parameter content
                if (document.getElementById("<%=txtInput.ClientID%>").getAttribute("ProcessQuickInput") == "true") {
                    var txtObj = document.getElementById("<%=txtInput.ClientID%>");
                    
                    if (txtObj.AllowPrompt == undefined || txtObj.AllowPrompt == null || txtObj.AllowPrompt == true)
                    {
                        alert("Please input or scan!");    
                        event.returnValue = false;
                        
                        //ITC-932-0200 2009-01-21 Tong.Zhi-Yong
                        try
                        {
                            //ShowInfo("Please input or scan!");
                        }
                        catch(e)
                        {
                            document.getElementById("<%=txtInput.ClientID%>").focus();
                            return;
                        }
                        
                        document.getElementById("<%=txtInput.ClientID%>").focus();                          
                    }
                    else
                    {
                        txtObj.AllowPrompt = true;                
                    }
                }
                
                event.returnValue = false;             
            }
			//modified by itc207013
			if ((ETFun != null)&&(ETFun != ""))
			{
				eval(ETFun);
			}
            
        } else {
            if (isClear == null) {
                if ((finishInputFlag)&&(event.keyCode != 17)) 
                {
                    document.getElementById("<%=txtInput.ClientID%>").value = "";
                    finishInputFlag = false;
                }                
            }
        
            if (getCommonInputObject().onkeypress == null) {
                getCommonInputObject().onkeypress = keyPress;
            }
        }
    }
    
    function keyPress() {
        var inputContent = document.getElementById("<%=txtInput.ClientID%>").value;
        var pattern = /^[-0-9a-zA-Z\s\*]*$/;
        var content = inputContent + String.fromCharCode(event.keyCode);
        var inputPattern = document.getElementById("<%=txtInput.ClientID%>").getAttribute("expression");
        
        if (inputPattern != null && inputPattern != "") {
            pattern = new RegExp(inputPattern);
        }
        
        if (pattern.test(content)) {
	        event.returnValue = true;
	    } else {
	        event.returnValue = false;
	    }
    }
    
    //计算时间
    function CountTime(timeStart1,timeStop1)
    {
        var flag1 = false;
        var tmp = timeStop1.getTime() - timeStart1.getTime();
        var hidTime = document.getElementById("<%=hidKeyAllowTime.ClientID %>").value;
        
        allowKeyInTime = parseInt(hidTime, 10);
        
        if(tmp <= allowKeyInTime)
        {
            flag1 = true;
        }
        
        return flag1;
    }    
    
    //show Error
    function showErrorMessage(errorContent)
    {
        window.showModalDialog('ErrMessageDisplayFram.aspx',errorContent,'dialogWidth:650px;dialogHeight:450px;status:no;help:no;menubar:no;toolbar:no;resize:no;');
        document.getElementById ("<%=txtInput.ClientID%>").focus();
    }    
    
    String.prototype.trim = function() {
        if (this == null) {
            this == "";
        }
        
        return this.replace(/^\s*(.*?)[\s\n]*$/g, '$1');
    }
    
    //public method
    function hasAvailableData() {
        return readIndex > writeIndex ? false : true;
    }

    //flag: Indicate whether return original string or upper case string
    //  flag == true : Original string will be returned if available
    //  otherwise, upper case string will be returned.
    function getAvailableData(param, flag) {
        if (!hasAvailableData()) {
            if (flag != null) {
                window.setTimeout("getAvailableData('" + param + "', " + flag + ")", 300);
            }
            else {
                window.setTimeout("getAvailableData('" + param + "')", 300);
            }
            return;
        } else {
            var returnData;
            if (flag != null && flag == true) {
                returnData = sInputOrig[readIndex];
            }
            else {
                returnData = sInput[readIndex];
            }
            
            readIndex++;
            eval(param + "('" + returnData + "');");     
        }
    }
    
    function clearData() {
        readIndex=0;
        writeIndex=-1;
    }
    
    function disableControl() {
        document.getElementById("<%=txtInput.ClientID%>").disabled = true;
    }
    
    function enableControl() {
        document.getElementById("<%=txtInput.ClientID%>").disabled = false;
    }
    
    function getCommonInputObject() {
        return document.getElementById ("<%=txtInput.ClientID%>");
    }
</script>